#include "CommandInterpreter.h"
#include "DrawXCG.h"
#include "draw.h"

bool CommandInterpreter::process_command(const std::string& sline, ConOutput& co_cout, ConOutput& co_cerr) {
    char line[256]; // 入力バッファ（適切なサイズを確保）
    std::string tsline = DNString(sline).Trim();
#ifdef USE_X68000
    strncpy(line, tsline.c_str(), sizeof(line));
#else
    strcpy_s(line, sizeof(line), tsline.c_str());
#endif
    line[strcspn(line, "\n")] = '\0'; // 改行文字を削除
    char* tokens[MAX_TOKENS];
    int token_count = split(line, ' ', tokens, MAX_TOKENS);
    if (token_count == 0) {
        return true; // 空行の場合は処理を続ける
    }
    return set_draw_cmd(token_count, tokens, co_cout, co_cerr);
}

bool CommandInterpreter::process_command_(const std::string& sline, ConOutput& co_cout, ConOutput& co_cerr) {
    const char* commands[] = {
        "exit", "step", "continue", "breakpoint", "output", "print",
        "list", "load", "run", "call", "draw", "reglist", "rreglist",
        "sample", "source", "quote", "lquote",
        "copy", "trace", "test", "help"
    };
    char line[256]; // 入力バッファ（適切なサイズを確保）
    std::string tsline = DNString(sline).Trim();
#ifdef USE_X68000
    strncpy(line, tsline.c_str(), sizeof(line));
#else
    strcpy_s(line, sizeof(line), tsline.c_str());
#endif
    line[strcspn(line, "\n")] = '\0'; // 改行文字を削除
    char* tokens[MAX_TOKENS];
    int token_count = split(line, ' ', tokens, MAX_TOKENS);
    if (token_count == 0) {
        return true; // 空行の場合は処理を続ける
    }
    const int command_count = sizeof(commands) / sizeof(commands[0]);
    CommandMatchResult result = matchCommand(tokens[0], commands, command_count);
    if (!result.matched) {
        printf("Unknown command: %s\n", tokens[0]);
        return true; // コマンドが不明な場合は処理を続ける
    }
    if (strcmp(result.command, "exit") == 0) {
        co_cout << "Exiting debug mode." << co_endl;
        return false; // デバッグモードを終了
    }
    else if (strcmp(result.command, "draw") == 0) {
        if (token_count > 1) {
            set_draw_cmd(token_count - 1, tokens + 1, co_cout, co_cerr);
        }
        else {
            co_cerr << "Usage: draw <commands>" << co_endl;
        }
    }
    return true;
}
